<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stijn Masschelein">

<title>Method Package - Generated Independent</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../generated/inverse_probability_weight.html" rel="next">
<link href="../generated/introduction.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../generated/introduction.html">Generated Variables</a></li><li class="breadcrumb-item"><a href="../generated/residual_dependent.html">Generated Independent</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Method Package</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../method_package.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Content</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../auxilary/introduction_to_r_rstudio_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rstudio installation and first code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../auxilary/introduction_to_rstudio_for_accfin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Rstudio for Accounting and Finance</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Slides</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Research Methods in Finance and Accounting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulations, Regressions, and Significance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Control Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Design 1: Fixed Effects and Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Design 2: Event Studies and Difference-in-Difference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_proposal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Feedback on Pitch and Proposal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../auxilary/matching_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Matching theory</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Friday Earnings Announcements</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/download_linking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS linking data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/linking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Combining databases</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/download_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Earnings announcements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/download_stocks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stock price data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/abnormal_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Abnormal returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Descriptive statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/regressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../freaky_friday/assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine_learning/predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predictions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine_learning/theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine_learning/application.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Peer Firms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine_learning/assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Generalised Linear Models</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generalised/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction and Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generalised/interpretation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interpretation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generalised/poisson.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Poisson Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Generated Variables</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generated/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generated/residual_dependent.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Generated Independent</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../generated/inverse_probability_weight.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IPW</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#correlated-step-1-control" id="toc-correlated-step-1-control" class="nav-link" data-scroll-target="#correlated-step-1-control">Correlated Step 1 control</a></li>
  <li><a href="#extra-controls-in-step-2" id="toc-extra-controls-in-step-2" class="nav-link" data-scroll-target="#extra-controls-in-step-2">Extra controls in step 2</a></li>
  <li><a href="#extra-correlated-controls-in-step-2" id="toc-extra-correlated-controls-in-step-2" class="nav-link" data-scroll-target="#extra-correlated-controls-in-step-2">Extra correlated controls in step 2</a></li>
  <li><a href="#run-simulations-as-a-large-dataframe" id="toc-run-simulations-as-a-large-dataframe" class="nav-link" data-scroll-target="#run-simulations-as-a-large-dataframe">Run simulations as a large dataframe</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generated Independent</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Stijn Masschelein </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This page is based on <span class="citation" data-cites="chen2018">Chen, Hribar, and Melessa (<a href="#ref-chen2018" role="doc-biblioref">2018</a>)</span> who show the potential problems of using a two-stage approach where in the second stage, we use the residuals from the first regression as a dependent variable. This approach is quite popular in the accounting and finance literature. The paper shows formally and with simulation that (1) these models can typically be estimated with 1 regression and that (2) the two-step procedure can be biased if they are not used carefully. The paper also re-analyses a number of accounting studies and shows that the results sometimes meaningfully change.</p>
<p>I am going to illustrate the issue with a number of simulated examples. As always, we will be interested in the effect of a variable <code>x</code> on <code>y</code> where we want to control for a variable <code>z</code>. The bias of the two-stage procedure will often depend on unobserved correlations between those variables which I will model with the unobserved variable <code>w</code>.</p>
<p>The two-step approach is to: - First run a regression <code>y ~ z</code> and calculate the residuals. - Second use those residuals to estimate the effect of x on the residuals <code>residuals ~ x</code></p>
<p>The one-step approach is to just run the regression <code>y ~ x + z</code>.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell" data-hash="residual_dependent_cache/html/setup_175befd4feca2df1521f9271f70f21c8">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_cowplot</span>(<span class="at">font_size =</span> <span class="dv">18</span>))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">i_am</span>(<span class="st">"generated/residual_dependent.qmd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at /Users/stijnmasschelein/Library/CloudStorage/Dropbox/Teaching/lecturenotes/method_package</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="residual_dependent_cache/html/parameters_80487bbd68415cbd7186e01bb26dcf92">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gof_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">230383</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="correlated-step-1-control" class="level2">
<h2 class="anchored" data-anchor-id="correlated-step-1-control">Correlated Step 1 control</h2>
<p>The basic problem is that in the two-step approach researchers regularly include <code>z</code> in the first regression and not in the second regression. If <code>z</code> and <code>x</code> are correlated, the two-step procedure will be biased downwards if the second step does not control for <code>z</code>. This can be seen in the simulated example below. I also show that the bias can be avoided by running the one-step regression, add <code>z</code> as a control variable, or use <code>z</code> to residualise both <code>x</code> and <code>y</code>.</p>
<div class="cell" data-hash="residual_dependent_cache/html/correlated-step-1_748268616984a0c098770e3c60509c90">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">w =</span> <span class="fu">rnorm</span>(N)) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z =</span> <span class="fu">rnorm</span>(N, w, <span class="dv">1</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">rnorm</span>(N, w, <span class="dv">1</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(N, x <span class="sc">+</span> z, <span class="dv">10</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z, <span class="at">data =</span> d1)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>lm1x <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> z, <span class="at">data =</span> d1)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>lm1y <span class="ot">&lt;-</span> <span class="fu">lm</span>(x <span class="sc">~</span> z, <span class="at">data =</span> d1)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">mutate</span>(d1,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">resid_y =</span> <span class="fu">resid</span>(lm1x),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">resid_x =</span> <span class="fu">resid</span>(lm1y))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>lm1resy <span class="ot">&lt;-</span> <span class="fu">lm</span>(resid_y <span class="sc">~</span> x, <span class="at">data =</span> d1)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>lm1resyz <span class="ot">&lt;-</span> <span class="fu">lm</span>(resid_y <span class="sc">~</span> x <span class="sc">+</span> z, <span class="at">data =</span> d1)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>lm1resyx <span class="ot">&lt;-</span> <span class="fu">lm</span>(resid_y <span class="sc">~</span> resid_x, <span class="at">data =</span> d1)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="at">onestep =</span> lm1, <span class="at">no_control =</span> lm1resy,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">with_control =</span> lm1resyz, <span class="at">double_resid =</span> lm1resyx),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">gof_map =</span> gof_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<!-- preamble start -->

    <script>
      function styleCell_8ftwb1eyf94ekoo56dxe(i, j, css_id) {
        var table = document.getElementById("tinytable_8ftwb1eyf94ekoo56dxe");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_8ftwb1eyf94ekoo56dxe');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_8ftwb1eyf94ekoo56dxe(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_8ftwb1eyf94ekoo56dxe");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(0, 0, 'tinytable_css_id26uiy6vjki403yaftvyt') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(0, 1, 'tinytable_css_idfgs0l7ep2cqgoqclyl05') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(0, 2, 'tinytable_css_idfgs0l7ep2cqgoqclyl05') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(0, 3, 'tinytable_css_idfgs0l7ep2cqgoqclyl05') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(0, 4, 'tinytable_css_idfgs0l7ep2cqgoqclyl05') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(1, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(1, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(1, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(1, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(1, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(2, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(2, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(2, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(2, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(2, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(3, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(3, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(3, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(3, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(3, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(4, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(4, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(4, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(4, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(4, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(5, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(5, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(5, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(5, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(5, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(6, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(6, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(6, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(6, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(6, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(7, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(7, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(7, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(7, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(7, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(8, 0, 'tinytable_css_idzcgzlogm7fulvsiy5car') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(8, 1, 'tinytable_css_id6f84u9hp0owb3poxbo6q') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(8, 2, 'tinytable_css_id6f84u9hp0owb3poxbo6q') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(8, 3, 'tinytable_css_id6f84u9hp0owb3poxbo6q') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(8, 4, 'tinytable_css_id6f84u9hp0owb3poxbo6q') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(9, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(9, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(9, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(9, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(9, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(10, 0, 'tinytable_css_ido5okq611l9mke0x3w9bm') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(10, 1, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(10, 2, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(10, 3, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
window.addEventListener('load', function () { styleCell_8ftwb1eyf94ekoo56dxe(10, 4, 'tinytable_css_idcvkq9mm0rlmz91l3mrep') })
    </script>

    <style>
    .table td.tinytable_css_id26uiy6vjki403yaftvyt, .table th.tinytable_css_id26uiy6vjki403yaftvyt {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idfgs0l7ep2cqgoqclyl05, .table th.tinytable_css_idfgs0l7ep2cqgoqclyl05 {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_ido5okq611l9mke0x3w9bm, .table th.tinytable_css_ido5okq611l9mke0x3w9bm {  text-align: left; }
    .table td.tinytable_css_idcvkq9mm0rlmz91l3mrep, .table th.tinytable_css_idcvkq9mm0rlmz91l3mrep {  text-align: center; }
    .table td.tinytable_css_idzcgzlogm7fulvsiy5car, .table th.tinytable_css_idzcgzlogm7fulvsiy5car {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_id6f84u9hp0owb3poxbo6q, .table th.tinytable_css_id6f84u9hp0owb3poxbo6q {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_8ftwb1eyf94ekoo56dxe" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">onestep</th>
                <th scope="col">no_control</th>
                <th scope="col">with_control</th>
                <th scope="col">double_resid</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>-0.014 </td>
                  <td>0.003  </td>
                  <td>0.009  </td>
                  <td>0.000  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.100)</td>
                  <td>(0.100)</td>
                  <td>(0.100)</td>
                  <td>(0.100)</td>
                </tr>
                <tr>
                  <td>x          </td>
                  <td>1.041  </td>
                  <td>0.783  </td>
                  <td>1.041  </td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.081)</td>
                  <td>(0.071)</td>
                  <td>(0.081)</td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>z          </td>
                  <td>0.913  </td>
                  <td>       </td>
                  <td>-0.517 </td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.081)</td>
                  <td>       </td>
                  <td>(0.081)</td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>resid_x    </td>
                  <td>       </td>
                  <td>       </td>
                  <td>       </td>
                  <td>1.041  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>       </td>
                  <td>       </td>
                  <td>       </td>
                  <td>(0.081)</td>
                </tr>
                <tr>
                  <td>Num.Obs.   </td>
                  <td>10000  </td>
                  <td>10000  </td>
                  <td>10000  </td>
                  <td>10000  </td>
                </tr>
                <tr>
                  <td>R2         </td>
                  <td>0.054  </td>
                  <td>0.012  </td>
                  <td>0.016  </td>
                  <td>0.016  </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
<section id="extra-controls-in-step-2" class="level2">
<h2 class="anchored" data-anchor-id="extra-controls-in-step-2">Extra controls in step 2</h2>
<p>In the next step, we can include extra controls, <code>z2</code>, in the second step. The bias will now depend on the correlations that the extra control has with the first stage controls and <code>x</code> and <code>y</code>. More importantly, the bias can now be an overestimation or underestimation. If the additional control is not correlated to <code>x</code> or <code>z1</code>, we still have the downward bias from before.</p>
<div class="cell" data-hash="residual_dependent_cache/html/additional-controls_8ae378bddb641d597c41ff8b59d1238f">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d1 <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">z1 =</span> z) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z2 =</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(N, x <span class="sc">+</span> z1 <span class="sc">+</span> z2, <span class="dv">10</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d2)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>lm2y <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> z1, <span class="at">data =</span> d2)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d2 <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid_y =</span> <span class="fu">resid</span>(lm2y))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>lm2resy <span class="ot">&lt;-</span> <span class="fu">lm</span>(resid_y <span class="sc">~</span> x <span class="sc">+</span> z2, <span class="at">data =</span> d2)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="at">onestep =</span> lm2, <span class="at">twostep =</span> lm2resy),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">gof_map =</span> gof_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<!-- preamble start -->

    <script>
      function styleCell_9yhuk0h9bhh3ea6b3ir4(i, j, css_id) {
        var table = document.getElementById("tinytable_9yhuk0h9bhh3ea6b3ir4");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_9yhuk0h9bhh3ea6b3ir4');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_9yhuk0h9bhh3ea6b3ir4(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_9yhuk0h9bhh3ea6b3ir4");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(0, 0, 'tinytable_css_idlnwvpd3wmvp743pvovlw') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(0, 1, 'tinytable_css_idq2y5w5otoe5qyyovtfz3') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(0, 2, 'tinytable_css_idq2y5w5otoe5qyyovtfz3') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(1, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(1, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(1, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(2, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(2, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(2, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(3, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(3, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(3, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(4, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(4, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(4, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(5, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(5, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(5, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(6, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(6, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(6, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(7, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(7, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(7, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(8, 0, 'tinytable_css_id553sxkhgg07e9yw2eql4') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(8, 1, 'tinytable_css_idocazmzl0c5o6dnbp3glf') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(8, 2, 'tinytable_css_idocazmzl0c5o6dnbp3glf') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(9, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(9, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(9, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(10, 0, 'tinytable_css_idt6de545hjfwigderthb6') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(10, 1, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
window.addEventListener('load', function () { styleCell_9yhuk0h9bhh3ea6b3ir4(10, 2, 'tinytable_css_id20mzi1nshd3u4h3f4958') })
    </script>

    <style>
    .table td.tinytable_css_idlnwvpd3wmvp743pvovlw, .table th.tinytable_css_idlnwvpd3wmvp743pvovlw {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idq2y5w5otoe5qyyovtfz3, .table th.tinytable_css_idq2y5w5otoe5qyyovtfz3 {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idt6de545hjfwigderthb6, .table th.tinytable_css_idt6de545hjfwigderthb6 {  text-align: left; }
    .table td.tinytable_css_id20mzi1nshd3u4h3f4958, .table th.tinytable_css_id20mzi1nshd3u4h3f4958 {  text-align: center; }
    .table td.tinytable_css_id553sxkhgg07e9yw2eql4, .table th.tinytable_css_id553sxkhgg07e9yw2eql4 {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idocazmzl0c5o6dnbp3glf, .table th.tinytable_css_idocazmzl0c5o6dnbp3glf {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_9yhuk0h9bhh3ea6b3ir4" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">onestep</th>
                <th scope="col">twostep</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>0.302  </td>
                  <td>0.015  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.100)</td>
                  <td>(0.100)</td>
                </tr>
                <tr>
                  <td>x          </td>
                  <td>1.126  </td>
                  <td>0.849  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.082)</td>
                  <td>(0.071)</td>
                </tr>
                <tr>
                  <td>z1         </td>
                  <td>0.946  </td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.081)</td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>z2         </td>
                  <td>0.826  </td>
                  <td>0.833  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.100)</td>
                  <td>(0.100)</td>
                </tr>
                <tr>
                  <td>Num.Obs.   </td>
                  <td>10000  </td>
                  <td>10000  </td>
                </tr>
                <tr>
                  <td>R2         </td>
                  <td>0.066  </td>
                  <td>0.021  </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
<section id="extra-correlated-controls-in-step-2" class="level2">
<h2 class="anchored" data-anchor-id="extra-correlated-controls-in-step-2">Extra correlated controls in step 2</h2>
<p>However, when the additional control is negatively correlated to both <code>z1</code> and <code>x</code> but positively to <code>y</code>, we get an upward bias.</p>
<div class="cell" data-hash="residual_dependent_cache/html/additional-correlated-controls_6c9bfb42980a9ba4b182450f632103d5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> d2 <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z3 =</span> <span class="fu">rnorm</span>(N, <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> w, <span class="dv">1</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(N, x <span class="sc">+</span> z1 <span class="sc">+</span> z3, <span class="dv">10</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid_y =</span> <span class="fu">resid</span>(<span class="fu">lm</span>(y <span class="sc">~</span> z1, <span class="at">data =</span> .)))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z1 <span class="sc">+</span> z3, <span class="at">data =</span> d3)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>lm3resy <span class="ot">&lt;-</span> <span class="fu">lm</span>(resid_y <span class="sc">~</span> x <span class="sc">+</span> z3, <span class="at">data =</span> d3)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="at">onestep =</span> lm3, <span class="at">twostep =</span> lm3resy),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">gof_map =</span> gof_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<!-- preamble start -->

    <script>
      function styleCell_atd1lg646x7u7vusq9ns(i, j, css_id) {
        var table = document.getElementById("tinytable_atd1lg646x7u7vusq9ns");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_atd1lg646x7u7vusq9ns');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_atd1lg646x7u7vusq9ns(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_atd1lg646x7u7vusq9ns");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(0, 0, 'tinytable_css_idnbvm7v6y1w8q9ofqok70') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(0, 1, 'tinytable_css_idfs8oqfjwfji2xeeoc6au') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(0, 2, 'tinytable_css_idfs8oqfjwfji2xeeoc6au') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(1, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(1, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(1, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(2, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(2, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(2, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(3, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(3, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(3, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(4, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(4, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(4, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(5, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(5, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(5, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(6, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(6, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(6, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(7, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(7, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(7, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(8, 0, 'tinytable_css_idz4xambisw1ilyoqvx9r8') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(8, 1, 'tinytable_css_idzrpe7bfctqyvt036aqmz') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(8, 2, 'tinytable_css_idzrpe7bfctqyvt036aqmz') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(9, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(9, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(9, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(10, 0, 'tinytable_css_id7fq5gg6atw69yg97wffv') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(10, 1, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
window.addEventListener('load', function () { styleCell_atd1lg646x7u7vusq9ns(10, 2, 'tinytable_css_id9nsp8i5nbbrkdb5ccvid') })
    </script>

    <style>
    .table td.tinytable_css_idnbvm7v6y1w8q9ofqok70, .table th.tinytable_css_idnbvm7v6y1w8q9ofqok70 {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idfs8oqfjwfji2xeeoc6au, .table th.tinytable_css_idfs8oqfjwfji2xeeoc6au {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_id7fq5gg6atw69yg97wffv, .table th.tinytable_css_id7fq5gg6atw69yg97wffv {  text-align: left; }
    .table td.tinytable_css_id9nsp8i5nbbrkdb5ccvid, .table th.tinytable_css_id9nsp8i5nbbrkdb5ccvid {  text-align: center; }
    .table td.tinytable_css_idz4xambisw1ilyoqvx9r8, .table th.tinytable_css_idz4xambisw1ilyoqvx9r8 {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idzrpe7bfctqyvt036aqmz, .table th.tinytable_css_idzrpe7bfctqyvt036aqmz {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_atd1lg646x7u7vusq9ns" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">onestep</th>
                <th scope="col">twostep</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>-0.141 </td>
                  <td>0.008  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.101)</td>
                  <td>(0.101)</td>
                </tr>
                <tr>
                  <td>x          </td>
                  <td>0.967  </td>
                  <td>1.038  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.094)</td>
                  <td>(0.093)</td>
                </tr>
                <tr>
                  <td>z1         </td>
                  <td>0.866  </td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.093)</td>
                  <td>       </td>
                </tr>
                <tr>
                  <td>z3         </td>
                  <td>0.910  </td>
                  <td>0.772  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.066)</td>
                  <td>(0.059)</td>
                </tr>
                <tr>
                  <td>Num.Obs.   </td>
                  <td>10000  </td>
                  <td>10000  </td>
                </tr>
                <tr>
                  <td>R2         </td>
                  <td>0.024  </td>
                  <td>0.018  </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</section>
<section id="run-simulations-as-a-large-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="run-simulations-as-a-large-dataframe">Run simulations as a large dataframe</h2>
<p>We can use a simulation approach to see whether that bias is persistent and not just a coincedence in the simulated data. First, we create the two functions that run the two step and one step approach and return the estimate and the p-value from the coefficient table.</p>
<div class="cell" data-hash="residual_dependent_cache/html/sim-functions_f3577552c54f154e05c468118aae3f14">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>two_step <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> z1, data)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">resid</span>(lm1) <span class="sc">~</span> x <span class="sc">+</span> z3, <span class="at">data =</span> data)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm2)<span class="sc">$</span>coefficients</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> coefs[<span class="st">"x"</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"pvalue"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>one_step <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z1 <span class="sc">+</span> z3, <span class="at">data =</span> data)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm)<span class="sc">$</span>coefficients</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> coefs[<span class="st">"x"</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"pvalue"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="fu">two_step</span>(d3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    estimate       pvalue 
1.037754e+00 1.279855e-28 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">one_step</span>(d3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    estimate       pvalue 
9.667333e-01 1.769225e-24 </code></pre>
</div>
</div>
<p>Next, we set up the simulation for 1000 simulations with 100 observations per data set. One trick for efficient simulations is to generate the data in one big data frame. You can see that we can still use the two step approach with <code>tibble</code> and <code>mutate</code> for exogenous and endogenous variables. We just need to be careful with the number of observations and use <code>ntotal</code>.</p>
<div class="cell" data-hash="residual_dependent_cache/html/sim-additional_92b40e3bf912a601436a2fc439959cb7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ntotal <span class="ot">&lt;-</span> nsim <span class="sc">*</span> N</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>simdata <span class="ot">&lt;-</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>nsim, <span class="at">each =</span> N),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> <span class="fu">rnorm</span>(ntotal)) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">z1 =</span> <span class="fu">rnorm</span>(ntotal, w, <span class="dv">1</span>),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">rnorm</span>(ntotal, w, <span class="dv">1</span>),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">z3 =</span> <span class="fu">rnorm</span>(ntotal, <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> w, <span class="dv">1</span>),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rnorm</span>(ntotal, x <span class="sc">+</span> z1 <span class="sc">+</span> z3, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can than use <code>nest</code> to create separate data by sample and calculate the estimate and p-value for each sample with our functions. The results are a vector with two values and we use <code>unnest_wider</code> to create separate columns. Finally, I calculate the difference between the two estimates.</p>
<div class="cell" data-hash="residual_dependent_cache/html/unnamed-chunk-8_8788a825a3e3cb4372706363e2a6ac2e">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">.by =</span> sample) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">two =</span> <span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">two_step</span>(.x)),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">one =</span> <span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">one_step</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(<span class="fu">c</span>(one, two), <span class="at">names_sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bias =</span> two_estimate <span class="sc">-</span> one_estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we can summarise the results and we see that the two step approach is likely to overestimate the effect of <code>x</code>.</p>
<div class="cell" data-hash="residual_dependent_cache/html/unnamed-chunk-9_59ab9b74564678f9fc89a0ef05c48999">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">M =</span> <span class="fu">mean</span>(bias), <span class="at">se =</span> <span class="fu">sd</span>(bias)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">n</span>()), </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">M_one =</span> <span class="fu">mean</span>(one_estimate), <span class="at">M_two =</span> <span class="fu">mean</span>(two_estimate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1  4
       M      se M_one M_two
   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 0.0860 0.00427  1.02  1.10</code></pre>
</div>
</div>
<p>The last part of the code calculates the percentage of simulated samples that gives a significant effect. If we are worried that we might not find a significant effect while there is one, this might be a legitimate problem. In this case, the bad approach is more likely to report a significant effect. Its not always easy doing the right thing.</p>
<div class="cell" data-hash="residual_dependent_cache/html/unnamed-chunk-10_9f2cd4017dcd50a309db3991ac46f607">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample, two_pvalue, one_pvalue) <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(two_pvalue, one_pvalue),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"var"</span>, <span class="at">values_to =</span> <span class="st">"pvalue"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_sign =</span> <span class="fu">if_else</span>(pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(is_sign), <span class="at">.by =</span> var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2  2
  var         mean
  &lt;chr&gt;      &lt;dbl&gt;
1 two_pvalue 0.21 
2 one_pvalue 0.173</code></pre>
</div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-chen2018" class="csl-entry" role="listitem">
Chen, Wei, Paul Hribar, and Samuel Melessa. 2018. <span>Incorrect <span>Inferences When Using Residuals</span> as <span>Dependent Variables</span>.</span> <em>Journal of Accounting Research</em> 56 (3): 75196. <a href="https://doi.org/10.1111/1475-679X.12195">https://doi.org/10.1111/1475-679X.12195</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../generated/introduction.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../generated/inverse_probability_weight.html" class="pagination-link">
        <span class="nav-page-text">IPW</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>